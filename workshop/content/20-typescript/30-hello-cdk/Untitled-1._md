+++
title = "Hello Lambda"
weight = 200
+++

## Lambda handler code

We'll start with the AWS Lambda handler code.

1. æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰ã§Lambdaã‚’TypeScriptã§è¨˜è¿°ã—ã‚„ã™ãã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
   1. `npm install --save-dev esbuild@0 @types/aws-lambda`
2. `cdk-workshop`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`lambda`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚
3. `lambda/hello.ts`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã€ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```ts
export const handler: AWSLambda.APIGatewayProxyHandler = async (event) => {
  console.log("request:", JSON.stringify(event, undefined, 2));
  return {
    statusCode: 200,
    headers: { "Content-Type": "text/plain" },
    body: `Hello, CDK! You've hit ${event.path}\n`
  };
};
```

This is a simple Lambda function which returns the text __"Hello, CDK! You've
hit [url path]"__. The function's output also includes the HTTP status code and
HTTP headers. These are used by API Gateway to formulate the HTTP response to
the user.

{{% notice info %}}
ã“ã®Lambdaé–¢æ•°ã¯TypeScriptã§å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«ã¯CDKãŒ[esbuild](https://esbuild.github.io/)ã§JavaScriptã«ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã€‚ã‚ãªãŸãŒTypeScriptã®åˆå­¦è€…ã§ã‚ã‚‹å ´åˆã€ã¾ã esbuildã«ã¤ã„ã¦æ·±ãçŸ¥ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚  
ãã®ä»–ã®è¨€èªã§ã®å®Ÿè£…ã«ã¤ã„ã¦ã¯[AWS Lambdaã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/lambda/latest/dg/welcome.html)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
{{% /notice %}}

## Install the AWS Lambda construct library

The AWS CDK is shipped with an extensive library of constructs called the __AWS
Construct Library__. The construct library is divided into __modules__, one for
each AWS service. For example, if you want to define an AWS Lambda function, we
will need to use the AWS Lambda construct library.

To discover and learn about AWS constructs, you can browse the [AWS Construct
Library reference](https://docs.aws.amazon.com/cdk/api/latest/docs/aws-construct-library.html).

![](./clib.png)

## A few words about copying & pasting in this workshop

In this workshop, we highly recommended to type CDK code instead of copying &
pasting (there's usually not much to type). This way, you'll be able to fully
experience what it's like to use the CDK. It's especially cool to see your IDE
help you with auto-complete, inline documentation and type safety.

![](./auto-complete.webp)

## Add an AWS Lambda Function to your stack

Add an `import` statement at the beginning of `lib/cdk-workshop-stack.ts`, and a
`lambda.Function` to your stack.


{{<highlight ts "hl_lines=2 8-13">}}
import * as cdk from 'aws-cdk-lib';
import * as lambda from 'aws-cdk-lib/aws-lambda';

export class CdkWorkshopStack extends cdk.Stack {
  constructor(scope: cdk.App, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    // defines an AWS Lambda resource
    const hello = new lambda.Function(this, 'HelloHandler', {
      runtime: lambda.Runtime.NODEJS_14_X,    // execution environment
      code: lambda.Code.fromAsset('lambda'),  // code loaded from "lambda" directory
      handler: 'hello.handler'                // file is "hello", function is "handler"
    });
  }
}
{{</highlight>}}

```ts


const hello = new NodejsFunction(this, "HelloHandler", {
  runtime: Runtime.NODEJS_16_X,
  entry: "lambda/hello.ts",
});

import { Stack, StackProps } from 'aws-cdk-lib';
import { Construct } from 'constructs';
import * as lambda from 'aws-cdk-lib/aws-lambda'

export class CdkWorkshopStack extends Stack {
  constructor(scope: Construct, id: string, props?: StackProps) {
    super(scope, id, props);

    // defines an AWS Lambda resource
    const hello = new lambda.Function(this, 'HelloHandler', {
      runtime: lambda.Runtime.NODEJS_16_X,    // execution environment
      code: lambda.Code.fromAsset('lambda'),  // code loaded from "lambda" directory
      handler: 'hello.handler',               // file is "hello", function is "handler"
    });
  }
}
```

æ³¨ç›®ã™ã¹ãã„ãã¤ã‹ã®ç‚¹ï¼š

- ã“ã®é–¢æ•°ã¯`NODEJS_16_X`(Nodejs v16.x)ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
- ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã¯ã€å…ˆç¨‹ä½œã£ãŸ `lambda` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚
  ãƒ‘ã‚¹ã¯ã€`cdk` ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰ç›¸å¯¾ãƒ‘ã‚¹ã§ã™ã€‚
- ãƒãƒ³ãƒ‰ãƒ©ãƒ¼é–¢æ•°ã®åå‰ã¯ `hello.handler` ï¼ˆã€Œhelloã€ã¯ãƒ•ã‚¡ã‚¤ãƒ«åã€ã€Œhandlerã€ã¯é–¢æ•°åã§ã™ï¼‰

## ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆ(constructs) ã¨ ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼(constructors) ã«ã¤ã„ã¦

ã”è¦§ã®ã¨ãŠã‚Šã€`CdkWorkshopStack`ã¨`lambda.Function`ã®ä¸¡æ–¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã‚¯ãƒ©ã‚¹ï¼ˆãŠã‚ˆã³CDKã®ä»–ã®å¤šãã®ã‚¯ãƒ©ã‚¹ï¼‰ã¯`(scope, id, props)`ã¨ã„ã†åŒã˜ã‚ˆã†ãªå¼•æ•°ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
ã“ã‚Œã¯ã€ã“ã‚Œã‚‰ã®ã‚¯ãƒ©ã‚¹ãŒã™ã¹ã¦**ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿**ã§ã‚ã‚‹ãŸã‚ã§ã™ã€‚
ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã¯CDKã‚¢ãƒ—ãƒªã®åŸºæœ¬çš„ãªæ§‹æˆè¦ç´ ã§ã™ã€‚
ãã‚Œã‚‰ã¯ã€Œã‚¯ãƒ©ã‚¦ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã€ã‚’è¡¨ç¾ã—ã¾ã™ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã‚¹ã‚³ãƒ¼ãƒ—ã‚’ä»‹ã—ã¦ã‚ˆã‚Šé«˜ã„ãƒ¬ãƒ™ãƒ«ã®æŠ½è±¡åŒ–ã«æ§‹ç¯‰ã§ãã¾ã™ã€‚
ã‚¹ã‚³ãƒ¼ãƒ—ã«ã¯ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã‚’å«ã‚ã‚‹ã“ã¨ãŒã§ãã€ãã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã«ã¯ä»–ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆãªã©ã‚’å«ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã¯å¸¸ã«åˆ¥ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã®ã‚¹ã‚³ãƒ¼ãƒ—å†…ã§ä½œæˆã•ã‚Œã€ä½œæˆã•ã‚ŒãŸã‚¹ã‚³ãƒ¼ãƒ—å†…ã§ä¸€æ„ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„è­˜åˆ¥å­ï¼ˆidï¼‰ã‚’æŒã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ã—ãŸãŒã£ã¦ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆåˆæœŸåŒ–å­ï¼ˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ï¼‰ã«ã¯å¸¸ã«æ¬¡ã®ã‚·ã‚°ãƒãƒãƒ£ãŒå¿…è¦ã§ã™ã€‚

1. **`scopeï¼š`** : æœ€åˆã®å¼•æ•°ã«ã¯ã€ã“ã®æ§‹æˆãŒä½œæˆã•ã‚Œã‚‹ã‚¹ã‚³ãƒ¼ãƒ—ã‚’å¿…ãšæŒ‡å®šã—ã¾ã™ã€‚
   ã»ã¨ã‚“ã©ã™ã¹ã¦ã®å ´åˆã€ç¾åœ¨ã® ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã‚¹ã‚³ãƒ¼ãƒ—å†…ã§ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã‚’å®šç¾©ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
   ã¤ã¾ã‚Šã€é€šå¸¸æœ€åˆã®å¼•æ•°ã«ã¯`this`ã‚’æ¸¡ã™ã ã‘ã§ã™ã€‚

2. **`id`** ï¼š 2ç•ªç›®ã®å¼•æ•°ã¯ã€æ§‹é€ ã®**ãƒ­ãƒ¼ã‚«ãƒ«ID**ã§ã™ã€‚
   ã“ã‚Œã¯ã€åŒã˜ã‚¹ã‚³ãƒ¼ãƒ—å†…ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆé–“ã§ä¸€æ„ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹IDã§ã™ã€‚
   CDKã¯ã“ã®IDã‚’ä½¿ç”¨ã—ã¦ã€ ã“ã®ã‚¹ã‚³ãƒ¼ãƒ—å†…ã§å®šç¾©ã•ã‚ŒãŸå„ãƒªã‚½ãƒ¼ã‚¹ã®[CloudFormation è«–ç†ID](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resources-section-structure.html)ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
   *CDKã®IDã®è©³ç´°*ã«ã¤ã„ã¦ã¯ã€[CDKãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«](https://docs.aws.amazon.com/cdk/latest/guide/identifiers.html#identifiers_logical_ids)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

3. **`props`** : æœ€å¾Œã®ï¼ˆå ´åˆã«ã‚ˆã£ã¦ã¯ä¸è¦ã§ã‚ã‚‹å ´åˆã‚‚ã‚ã‚‹ï¼‰å¼•æ•°ã¯ã€åˆæœŸåŒ–ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ã‚»ãƒƒãƒˆã§ã™ã€‚
   ã“ã‚Œã‚‰ã¯å„ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã§å›ºæœ‰ã§ã™ã€‚
   ãŸã¨ãˆã°ã€`lambda.Function`ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ãƒˆã¯`runtime`ã€`code`ã€`handler`ã®ã‚ˆã†ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å—ã‘å–ã‚Šã¾ã™ã€‚
   IDEã®ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã¾ãŸã¯[ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.aws.amazon.com/cdk/api/latest/docs/aws-lambda-readme.html)ã‚’ä½¿ç”¨ã—ã¦ã€ã•ã¾ã–ã¾ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’èª¿ã¹ã‚‰ã‚Œã¾ã™ã€‚

## Diff

Save your code, and let's take a quick look at the diff before we deploy:

```
cdk diff
```

Output would look like this:

```text
Stack CdkWorkshopStack
IAM Statement Changes
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”‚ Resource                        â”‚ Effect â”‚ Action         â”‚ Principal                    â”‚ Condition â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + â”‚ ${HelloHandler/ServiceRole.Arn} â”‚ Allow  â”‚ sts:AssumeRole â”‚ Service:lambda.amazonaws.com â”‚           â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
IAM Policy Changes
â”Œâ”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   â”‚ Resource                    â”‚ Managed Policy ARN                                                             â”‚
â”œâ”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ + â”‚ ${HelloHandler/ServiceRole} â”‚ arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole â”‚
â””â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
(NOTE: There may be security-related changes not in this list. See https://github.com/aws/aws-cdk/issues/1299)

Parameters
[+] Parameter AssetParameters/3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7/S3Bucket AssetParameters3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7S3BucketEB5CA0D6: {"Type":"String","Description":"S3 bucket for asset \"3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7\""}
[+] Parameter AssetParameters/3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7/S3VersionKey AssetParameters3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7S3VersionKeyC5F120D1: {"Type":"String","Description":"S3 key for asset version \"3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7\""}
[+] Parameter AssetParameters/3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7/ArtifactHash AssetParameters3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7ArtifactHashBAACCCD2: {"Type":"String","Description":"Artifact hash for asset \"3342065582ab8a3599385f447c9f5d5b141c726eb5dc468594ec8450a97f3cb7\""}

Resources
[+] AWS::IAM::Role HelloHandler/ServiceRole HelloHandlerServiceRole11EF7C63
[+] AWS::Lambda::Function HelloHandler HelloHandler2E4FBA4D
```

As you can see, this code synthesizes an __AWS::Lambda::Function__ resource. It
also synthesized a couple of [CloudFormation
parameters](https://docs.aws.amazon.com/cdk/latest/guide/get_cfn_param.html)
that are used by the toolkit to propagate the location of the handler code.

## Deploy

Let's deploy:

```
cdk deploy
```

You'll notice that `cdk deploy` not only deployed your CloudFormation stack, but
also archived and uploaded the `lambda` directory from your disk to the
bootstrap bucket.

## Testing our function

Let's go to the AWS Lambda Console and test our function.

1. Open the [AWS Lambda
   Console](https://console.aws.amazon.com/lambda/home#/functions) (make sure
   you are in the correct region).

    You should see our function:

    ![](./lambda-1.png)

2. Click on the function name to go to the console.

3. Click on the __Test__ button to open the __Configure test event__ dialog:

    ![](./lambda-2.png)

4. Select __Amazon API Gateway AWS Proxy__ from the __Event template__ list.

5. Enter `test` under __Event name__.

    ![](./lambda-3.png)

6. Hit __Create__.

7. Click __Test__ again and wait for the execution to complete.

8. Expand __Details__ in the __Execution result__ pane and you should see our expected output:

    ![](./lambda-4.png)

# ğŸ‘
